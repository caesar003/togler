#!/bin/bash

VERSION="__VERSION__"

# ---------------------------
# Helper Functions
# ---------------------------

# Display messages with consistent formatting
log_info() { echo "â„¹ï¸  $1"; }
log_success() { echo "âœ… $1"; }
log_error() { echo "âŒ Error: $1"; }
log_warning() { echo "âš ï¸  Warning: $1"; }

# Application-specific mappings for process names and window classes
get_process_pattern() {
	local app="$1"
	case "$app" in
		"gnome-terminal")
			echo "gnome-terminal-server"
			;;
		"code")
			echo "code"
			;;
		"firefox")
			echo "firefox"
			;;
		*)
			echo "$app"
			;;
	esac
}

get_window_class() {
	local app="$1"
	case "$app" in
		"gnome-terminal")
			echo "Gnome-terminal"
			;;
		"code")
			echo "Code"
			;;
		"firefox")
			echo "Firefox"
			;;
		*)
			echo "$app"
			;;
	esac
}



# Prompt user for input with validation
prompt_required() {
	local prompt="$1"
	local var_name="$2"
	local value

	read -rp "$prompt" value
	if [ -z "$value" ]; then
		log_error "$var_name cannot be empty"
		exit 1
	fi
	echo "$value"
}

prompt_optional() {
	local prompt="$1"
	local default="$2"
	local value

	read -rp "$prompt" value
	echo "${value:-$default}"
}

# Check if command exists
require_command() {
	local cmd="$1"
	local install_hint="$2"

	if ! command -v "$cmd" &>/dev/null; then
		log_error "$cmd is not installed. $install_hint"
		exit 1
	fi
}

# Get gsettings value safely
get_setting() {
	local schema="$1"
	local key="$2"
	gsettings get "$schema" "$key" 2>/dev/null || echo ""
}

set_setting() {
	local schema="$1"
	local key="$2"
	local value="$3"
	gsettings set "$schema" "$key" "$value"
}

# Clean quotes from gsettings output
clean_quotes() {
	echo "$1" | sed "s/^'//; s/'$//"
}

# Check if running in terminal
is_terminal() {
	[ -t 1 ]
}

# Check session type
is_wayland() {
	[ "$XDG_SESSION_TYPE" = "wayland" ]
}

# Find custom keybinding path for app
find_app_binding() {
	local app_name="$1"
	local existing=$(get_setting "org.gnome.settings-daemon.plugins.media-keys" "custom-keybindings")

	for i in {0..50}; do
		if ! echo "$existing" | grep -q "custom$i"; then
			continue
		fi

		local path="/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom$i/"
		local command=$(get_setting "org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:$path" "command")

		if [[ "$command" == "'toggle-$app_name'" ]] || [[ "$command" == "'togler --toggle $app_name'" ]]; then
			echo "$path"
			return 0
		fi
	done

	return 1
}

# Find next available custom keybinding slot
find_next_slot() {
	local existing=$(get_setting "org.gnome.settings-daemon.plugins.media-keys" "custom-keybindings")
	local new_index=0

	while echo "$existing" | grep -q "custom$new_index"; do
		new_index=$((new_index + 1))
	done

	echo "$new_index"
}

# ---------------------------
# Core functions
# ---------------------------

print_version() {
	echo "togler version $VERSION"
	exit 0
}

print_help() {
	echo "Usage:"
	echo "  togler --version | -v"
	echo "        Show version information"
	echo
	echo "  togler --help | -h"
	echo "        Show this help message"
	echo
	echo "  togler --toggle | -t <app-name>"
	echo "        Toggle visibility of windows for the specified application"
	echo
	echo "  togler --bind | -b [<key>] [<app-name>]"
	echo "        Bind a key combination to toggle the application"
	echo "        Prompts interactively if arguments are not provided"
	echo
	echo "  togler --list | -l"
	echo "        List available bindings"
  echo
  echo "  togler --delete | -d [<app-name>]"
  echo "        Delete current keybinding"
	echo "        Prompts interactively if app-name is not provided"
	echo
	echo "  togler --add | -a [<app-name>] [<shortcut-name>] [<key>]"
	echo "        Create a GNOME shortcut to toggle an application"
	echo "        Prompts interactively for missing arguments"
	echo
	echo "Examples:"
	echo "  togler -t code"
	echo "  togler -b '<Super>c' code"
	echo "  togler -a firefox 'Toggle Firefox' '<Alt>f'"
	exit 0
}

list_bindings() {
	log_info "Listing all Togler bindings..."
	echo

	local existing=$(get_setting "org.gnome.settings-daemon.plugins.media-keys" "custom-keybindings")

	if [ "$existing" = "@as []" ]; then
		log_info "No custom shortcuts found"
		return 0
	fi

	local found_togler_bindings=0
	local binding_count=0
	local paths=$(echo "$existing" | grep -o "custom[0-9]\+" | sort -V)

	for custom_id in $paths; do
		local path="/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/$custom_id/"
		local command=$(get_setting "org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:$path" "command")

		if [ -z "$command" ] || [ "$command" = "''" ]; then
			continue
		fi

		if [[ "$command" == *"togler --toggle"* ]] || [[ "$command" == *"toggle-"* ]]; then
			found_togler_bindings=1
			binding_count=$((binding_count + 1))

			local name=$(get_setting "org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:$path" "name")
			local binding=$(get_setting "org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:$path" "binding")

			name=$(clean_quotes "$name")
			command=$(clean_quotes "$command")
			binding=$(clean_quotes "$binding")

			local app_name=""
			if [[ "$command" == *"togler --toggle "* ]]; then
				app_name=$(echo "$command" | sed 's/.*togler --toggle //')
			elif [[ "$command" == *"toggle-"* ]]; then
				app_name=$(echo "$command" | sed 's/toggle-//')
			fi

			echo "ðŸŽ¯ $name"
			echo "   App:     $app_name"
			echo "   Key:     $binding"
			echo
		fi
	done

	if [ $found_togler_bindings -eq 0 ]; then
		log_info "No Togler bindings found"
		echo "ðŸ’¡ Use 'togler --add <app>' to create your first binding"
	else
		echo "ðŸ“Š Found $binding_count Togler binding(s)"
	fi
}

bind_key() {
	local key_binding="$1"
	local app_name="$2"

	# Interactive prompts using helpers
	if [ -z "$key_binding" ]; then
		key_binding=$(prompt_required "ðŸŽ¹ Enter keybinding (e.g., <Alt>f, <Super>Return): " "Keybinding")
	fi

	if [ -z "$app_name" ]; then
		app_name=$(prompt_required "ðŸ“± Enter application name (e.g., firefox, code): " "Application name")
	fi

	local existing=$(get_setting "org.gnome.settings-daemon.plugins.media-keys" "custom-keybindings")

	if [ "$existing" = "@as []" ]; then
		log_error "No existing shortcuts found for '$app_name'"
		echo "ðŸ’¡ Use 'togler --add $app_name' to create a new shortcut first"
		exit 1
	fi

	# Use helper function to find binding
	local found_path
	if found_path=$(find_app_binding "$app_name"); then
		local old_binding=$(get_setting "org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:$found_path" "binding")

		if set_setting "org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:$found_path" "binding" "$key_binding"; then
			log_success "Successfully updated keybinding for '$app_name'"
			echo "   Old binding: $(clean_quotes "$old_binding")"
			echo "   New binding: $key_binding"
		else
			log_error "Failed to update keybinding"
			exit 1
		fi
	else
		log_error "No existing shortcut found for '$app_name'"
		echo "ðŸ’¡ Available options:"
		echo "   1. Use 'togler --add $app_name \"Toggle $app_name\" \"$key_binding\"' to create a new shortcut"
		echo "   2. Check existing shortcuts with: gsettings get org.gnome.settings-daemon.plugins.media-keys custom-keybindings"

		local create_new=$(prompt_optional "ðŸ¤” Would you like to create a new shortcut instead? [y/N]: " "N")
		if [[ "$create_new" == "y" || "$create_new" == "Y" ]]; then
			add_app "$app_name" "Toggle $app_name" "$key_binding"
		else
			exit 1
		fi
	fi
}

delete_binding() {
	local app_name="$1"

	# Prompt for the application name if it wasn't provided as an argument
	if [ -z "$app_name" ]; then
		app_name=$(prompt_required "ðŸ“± Enter app name for the binding to delete (e.g., code): " "Application name")
	fi

	log_info "Searching for binding for '$app_name'..."

	# Use the helper function to find the keybinding's path
	local found_path
	if ! found_path=$(find_app_binding "$app_name"); then
		log_error "No binding found for '$app_name'."
		echo "ðŸ’¡ Use 'togler --list' to see all available bindings."
		exit 1
	fi

	# --- Confirmation Prompt Added ---
	local confirm
	confirm=$(prompt_optional "ðŸ¤” Are you sure? This binding is too good to be deleted ðŸ˜‰ [y/N]: " "N")

	if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
		log_info "Deletion cancelled. That was a close one!"
		exit 0
	fi
	# --- End of Change ---

	# Get the current list of keybindings
	local current_list
	current_list=$(get_setting "org.gnome.settings-daemon.plugins.media-keys" "custom-keybindings")

	# Rebuild the list, excluding the path we want to remove
	local new_list="["
	local first=true
	# This pipeline extracts just the paths from the gsettings string array format
	local paths=$(echo "$current_list" | grep -oP "'[^']+'" | sed "s/'//g")

	for path in $paths; do
		if [ "$path" != "$found_path" ]; then
			if ! $first; then
				new_list="$new_list, "
			fi
			new_list="$new_list'$path'"
			first=false
		fi
	done
	new_list="$new_list]"

	# GSettings expects a specific format for an empty array
	if [ "$new_list" = "[]" ]; then
		new_list="@as []"
	fi

	# Apply the new, filtered list
	if set_setting "org.gnome.settings-daemon.plugins.media-keys" "custom-keybindings" "$new_list"; then
		# Resetting the old path is good practice for cleanup
		gsettings reset-recursively "org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:$found_path" &>/dev/null
		log_success "Successfully deleted binding for '$app_name'."
	else
		log_error "Failed to delete the keybinding."
		exit 1
	fi
}

toggle() {
	if is_terminal; then
		echo "ðŸ¤” Looks like you're running this from a terminal."
		echo "ðŸ’¡ For best results, assign 'togler -t $APP_NAME' to a keyboard shortcut instead."
		echo
	fi

	if is_wayland; then
		log_warning "Wayland detected!"
		echo "togler relies on xdotool, which does not work under Wayland."
		echo "For best results, log in using an X11 session instead."
		exit 1
	fi

	require_command "xdotool" "Install it with: sudo apt install -y xdotool"

	local process_pattern=$(get_process_pattern "$APP_NAME")
	local window_class=$(get_window_class "$APP_NAME")

	if pgrep -f "$process_pattern" >/dev/null; then
		active_win_id=$(xdotool getactivewindow 2>/dev/null)
		app_win_ids=$(xdotool search --onlyvisible --class "$APP_NAME" | sort -n)

		if [ -z "$app_win_ids" ]; then
			"$APP_NAME" &
			exit 0
		fi

		win_array=($app_win_ids)
		num_windows=${#win_array[@]}

		if [ $num_windows -eq 1 ]; then
			win_id=${win_array[0]}
			if [ "$win_id" = "$active_win_id" ]; then
				xdotool windowminimize "$win_id"
			else
				xdotool windowactivate "$win_id"
			fi
			exit 0
		fi

		active_app_window=""
		active_index=-1

		for i in "${!win_array[@]}"; do
			if [ "${win_array[$i]}" = "$active_win_id" ]; then
				active_app_window="${win_array[$i]}"
				active_index=$i
				break
			fi
		done

		mkdir -p /tmp/togler 2>/dev/null || true
		state_file="/tmp/togler/${APP_NAME}_state"

		last_action=""
		if [ -f "$state_file" ]; then
			last_action=$(cat "$state_file" 2>/dev/null)
		fi

		if [ $active_index -eq -1 ]; then
			xdotool windowactivate "${win_array[0]}"
			echo "activated_${win_array[0]}" >"$state_file"
		elif [ $active_index -eq $((num_windows - 1)) ]; then
			xdotool windowminimize "$active_app_window"
			echo "minimized_$active_app_window" >"$state_file"
		else
			if [[ "$last_action" == "minimized_"* ]] && [ $active_index -eq $((num_windows - 2)) ]; then
				xdotool windowactivate "${win_array[0]}"
				echo "activated_${win_array[0]}" >"$state_file"
			else
				next_index=$((active_index + 1))
				xdotool windowactivate "${win_array[$next_index]}"
				echo "activated_${win_array[$next_index]}" >"$state_file"
			fi
		fi
	else
		"$APP_NAME" &
	fi
}

add_app() {
	local app_command="$1"
	local shortcut_name="$2"
	local key_binding="$3"

	# Interactive prompts using helpers
	if [ -z "$app_command" ]; then
		echo "ðŸ›   Add new toggleable app"
		app_command=$(prompt_required "ðŸ‘‰ Application command (e.g., code, firefox): " "Application command")
	fi

	if [ -z "$shortcut_name" ]; then
		shortcut_name=$(prompt_optional "ðŸ“› Shortcut name (e.g., Toggle Firefox): " "Toggle $app_command")
	fi

	if [ -z "$key_binding" ]; then
		key_binding=$(prompt_required "ðŸŽ¹ Keybinding (e.g., <Alt>f): " "Keybinding")
	fi

	local toggle_command="togler --toggle $app_command"
	local existing=$(get_setting "org.gnome.settings-daemon.plugins.media-keys" "custom-keybindings")
	local new_index=$(find_next_slot)
	local new_path="/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom$new_index/"

	# Update custom-keybindings list
	local updated
	if [ "$existing" = "@as []" ]; then
		updated="['$new_path']"
	else
		updated=$(echo "$existing" | sed 's/]$//')
		updated="$updated, '$new_path']"
	fi

	# Apply the keybinding using helper functions
	if set_setting "org.gnome.settings-daemon.plugins.media-keys" "custom-keybindings" "$updated" &&
		set_setting "org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:$new_path" "name" "$shortcut_name" &&
		set_setting "org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:$new_path" "command" "$toggle_command" &&
		set_setting "org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:$new_path" "binding" "$key_binding"; then
		log_success "Successfully added GNOME shortcut for '$shortcut_name' with keybinding $key_binding"
	else
		log_error "Failed to create GNOME keybinding"
		exit 1
	fi
}

# ---------------------------
# Entry point
# ---------------------------

case "$1" in
-v | --version)
	print_version
	;;
-h | --help)
	print_help
	;;
-t | --toggle)
	APP_NAME="$2"
	if [ -z "$APP_NAME" ]; then
		log_error "Application name required for --toggle"
		exit 1
	fi
	toggle
	;;
-a | --add)
	add_app "$2" "$3" "$4"
	;;
-b | --bind)
	bind_key "$2" "$3"
	;;
-l | --list)
	list_bindings
	;;

-d | --delete)
	delete_binding $2
	;;
*)
	print_help
	;;
esac
