#!/bin/bash

VERSION="__VERSION__"

print_version() {
	echo "togler version $VERSION"
	exit 0
}

print_help() {
	echo "Usage:"
	echo "  togler --version | -v              Show version"
	echo "  togler --help    | -h              Show help"
	echo "  togler --toggle  | -t <app-name>   Toggle application windows"
	exit 0
}

toggle() {
	if [ -t 1 ]; then
		echo "ðŸ¤” Looks like you're running this from a terminal."
		echo "ðŸ’¡ For best results, assign 'togler -t $APP_NAME' to a keyboard shortcut instead."
		echo
	fi

	if [ "$XDG_SESSION_TYPE" = "wayland" ]; then
		echo "Warning: Wayland detected!"
		echo "togler relies on xdotool, which does not work under Wayland."
		echo "For best results, log in using an X11 session instead."
		exit 1
	fi

	if ! command -v xdotool &>/dev/null; then
		echo "Error: xdotool is not installed. Install it with: sudo apt install -y xdotool"
		exit 1
	fi

	if pgrep -x "$APP_NAME" >/dev/null; then
		active_win_id=$(xdotool getactivewindow 2>/dev/null)
		app_win_ids=$(xdotool search --onlyvisible --class "$APP_NAME" | sort -n)

		if [ -z "$app_win_ids" ]; then
			exit 0
		fi

		win_array=($app_win_ids)
		num_windows=${#win_array[@]}

		if [ $num_windows -eq 1 ]; then
			win_id=${win_array[0]}
			if [ "$win_id" = "$active_win_id" ]; then
				xdotool windowminimize "$win_id"
			else
				xdotool windowactivate "$win_id"
			fi
			exit 0
		fi

		active_app_window=""
		active_index=-1

		for i in "${!win_array[@]}"; do
			if [ "${win_array[$i]}" = "$active_win_id" ]; then
				active_app_window="${win_array[$i]}"
				active_index=$i
				break
			fi
		done

		mkdir -p /tmp/togler 2>/dev/null || true
		state_file="/tmp/togler/${APP_NAME}_state"

		last_action=""
		if [ -f "$state_file" ]; then
			last_action=$(cat "$state_file" 2>/dev/null)
		fi

		if [ $active_index -eq -1 ]; then
			xdotool windowactivate "${win_array[0]}"
			echo "activated_${win_array[0]}" >"$state_file"
		elif [ $active_index -eq $((num_windows - 1)) ]; then
			xdotool windowminimize "$active_app_window"
			echo "minimized_$active_app_window" >"$state_file"
		else
			if [[ "$last_action" == "minimized_"* ]] && [ $active_index -eq $((num_windows - 2)) ]; then
				xdotool windowactivate "${win_array[0]}"
				echo "activated_${win_array[0]}" >"$state_file"
			else
				next_index=$((active_index + 1))
				xdotool windowactivate "${win_array[$next_index]}"
				echo "activated_${win_array[$next_index]}" >"$state_file"
			fi
		fi
	else
		"$APP_NAME" &
	fi
}

# ---------------------------
# Entry point
# ---------------------------

case "$1" in
-v | --version)
	print_version
	;;
-h | --help)
	print_help
	;;
-t | --toggle)
	APP_NAME="$2"
	if [ -z "$APP_NAME" ]; then
		echo "Error: Application name required for --toggle"
		exit 1
	fi
	toggle
	;;
*)
	print_help
	;;
esac
